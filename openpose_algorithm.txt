                                            Openpose 2D人体骨架识别的算法
前言：
  经过上一阶段的学习，我对目标检测这一方向的基础模型有了深刻的认识，Faster-RCNN，Yolo系列等模型在检测目标是否存在这一领域有明显的优势。但这仅仅是
目标检测中最简单测层次，在实际应用中只关心目标是否存在往往是不够的，在一些高精度的检测环境中目标的姿态检测也是不容忽略的，例如：在AR游戏中玩家的肢体
动作是驱动游戏人物的动力；顶尖的教练团队可以通过AI捕捉运动员的动作来分析各种运动数据已制定更好的训练计划；在自动驾驶领域通过判定路边行人的姿态可以判断
出他是想横穿马路还是站立等待，有了这些更精确的信息可以帮助自动驾驶汽车做出更准确，更安全的决策。因此，CMU感知计算实验室于2017年发表了一篇关于人体姿态
估计的论文，由此Openpose面世。

介绍：
  Openpose的设计思路是‘自下而上’的，即先检测图片中所有人体的关键点，然后将这些关键点再一一对应到所属的人物个体上。这样做的好处是：相较于top-down
的思路需要先检测图像中所有的人在检测人体的关键点，openpose避免了前者严重依赖第一部检测结果的问题，这会大大提高检测关键点的精确度。其次，当图像中的检
测的人数越多，openpose的优势就越明显，因为前者在检测人体这一步上需要耗费大量时间。但是bottom-up的方法也存在需要改进的地方，例如要将关键点对应到不
同人物个体上算法复杂度很高，没办法利用全局上下文信息等。为解决这些问题，openpose提供了改进方案：PCM (Part Confidence Map) 和 PAF (Part
Affinity Fields). 为了更好的联系全局上下文信息，尽可能多的检测出一些不明显的关键点。openpose网络结构除了有主干网络VGG19用于提取图片特征外，在后
面还加入了stage模块，每个stage模块都是由卷积+PCM和卷积+PAF平行构成并计算其Loss。前一个模块的输出会被当作已知信息进入下一个模块，这样做的好处是：
前面的模块很容易就检测出一些明显的关键点，例如眼睛，鼻子等，通过这些关键点的位置。后面的模块可以逐步推断出一些被遮挡的或者不明显的关键点信息。

PCM：
  PCM简单来说就是关键点的热力图。人体的关键点通常是一些有一定自由度的关节，例如肩、肘、膝等，或者明显的面部特征，例如眼、耳、鼻等。将这些相邻的关键点
用直线连接起来就形成了简易的人体骨架，每一根线对应一根人体骨骼，除此之外openpose还在耳朵和肩膀之间增加了一条虚拟骨骼，因此openpose中的人体骨架一般
有19根骨骼，18个关键点。PCM将每一个关键点作为一个通道输出，另外增加一个通道作为背景输出。有了背景输出，一方面增加了监督信息有利于网络的学习；另一方面
背景也可以作为下一个stage的输入，可以更好的获得关键点之间的语义信息。在网络中，每一阶段的PCM Loss会被单独计算，依赖的ground truth用高斯核来创建，
Loss函数采用L2 Loss。考虑到不是所有的关键点都在训练集中被标注了。为了减少未标记的关键点对学习过程的影响，将没有被标记的关键点的权重设为0，其余被标记
的关键点和非关键点的权重均为1。

PAF：
  之前提到要将检测出的关键点一一对应到正确的人体上需要很高的算法复杂度，因此openpose提出一个解决方案，即PAF (部分亲和力场)。他的主要思路是计算不同
关键点之间的亲和力，如果亲和力大，则属于同一个人的不同关节，亲和力小，则是不同人体上的关节。亲和力被看作是一个有x，y坐标所组成的二维向量，openpose中
一共有19根骨骼，所以PAF的输出通道是19*2=38. PAF的定义方式是，把一根骨骼的长度，即两个关节之间的直线距离作为这个field的长度，然后再认为定义它的宽
度，处于这个PAF内的点是非零向量，之外的点则为0向量，并且用从一个关节指向另一个关节的单位向量表示有意义的非零向量。如果一个像素点位于多个PAF内，则取该
点所有向量的均值向量。亲和力的计算是通过均匀采样的方式进行的，最终的亲和力表示为所采集的样点的PAF向量。得到了每队关节之间的亲和力数值，就可以进行配对了，
但openpose中所用到方法并不是简单的把亲和力最大的关节进行配对，而是采用匈牙利算法进行最大值匹配。因为在实际匹配过程中会出现1跟2的亲和力对于1来说是最
大的，但2跟3的亲和力对于2来说是最大的，这样的结果回到是配对过程出现混乱。匈牙利算法可以进一步优化这个问题，简单来说就是将所有关节点之间的配对关系用二分
图表示，从第一个关节点开始匹配，如果满足最大值的要求则继续匹配下一个，如果中途出现某个关节点没有对应的匹配对象，则对之前匹配过的关节点进行重新分配，重
复这个过程知道所有关节点都匹配完毕且实现全局亲和力最大化。

总结：
  openpose是一个应用在人体姿态检测的算法模型，除了2D人体骨架识别目前还支持3D人体姿态估计和重建。相较于之前的人体姿态检测算法，openpose算法的设计
思路从一开始就进行了优化，不在遵循自上而下的设计思路，而是跳过人体检测直接检测关键点，这使得这一模型在运行速度上有了显著的提高，通过使用PAFs方案也大大
降低了关键点匹配问题的算法复杂度。除了这些优点，openpose的鲁棒性也很高，这得益于他们收集的巨量数据。当然，openpose也并不是一个完美的算法，人体在特
殊场景下的姿态openpose的检测效果较差，例如瑜伽动作，平躺的人体等。尽管如此，openpose的出现也为未来许多新零售行业带来了商机，将openpose与face
alignment结合可以催生3D试妆，3D眼镜等功能，将其与pose alignment结合可以实现3D试衣，3D交互游戏等，与D／2D image segmentasion 结合，为3D
渲染提供了边界位置服务以及背景替换的虚拟穿越服务等等。
